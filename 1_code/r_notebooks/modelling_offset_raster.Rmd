
```{r setup, include=FALSE, cache=FALSE}
#Set root directory to R project root
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r eval=FALSE}
library(raster)
library(dplyr)
library(foreach)
library(stringr)
```

### Import GEE rasters

#### Mosaic rasters

```{r eval=FALSE}
# dataPath <- "/Volumes/GoogleDrive/My Drive/PhD/thesis/chapter_1/empirical/0_data/external/CL_LiDAR/grid_metrics_surfaces/"

bl<-list.dirs(path="0_data/external/GEE_rasters/test/", full.names = F, recursive = F)

#set temp directory to an external drive to free up harddrive space
rasterOptions(tmpdir=file.path("../r_tmp")) 


foreach (j = 1:length(bl)) %do%

{ 
  t1 = proc.time()
  print(paste("---- Begin",bl[j], Sys.time()))
  # fp<-combine_words(bl[j],after='*.tif$')
  fl <- list.files(path=paste0("0_data/external/GEE_rasters/test/", bl[j]), pattern = '*.tif$', recursive = T, full.names = T)
  print(paste("----",bl[j]," file scan complete", Sys.time()))
  fl <- lapply(fl, brick)
  print(paste("----",bl[j]," lapply raster::brick  complete", Sys.time()))
  #fl <- lapply(fl, projectRaster,crs="+init=EPSG:3400")
  print(paste("----",bl[j]," projectRaster complete", Sys.time()))
  fl$fun <- mean
  fl$tolerance <-.5
  x <- do.call(raster::mosaic, fl)
  print(paste("----",bl[j]," mosaic complete!", Sys.time()))
  # x <- projectRaster(x, crs = st_crs(c_bb)$proj4string)
  # print(paste("----",bl[j]," projectRaster complete", Sys.time()))
  # x<-raster::crop(x ,c_bb)
  # print(paste("----",bl[j]," crop complete", Sys.time()))
  #assign(paste0(bl[j],'_mosaic'), x)
  writeRaster(x, filename=paste0("0_data/manual/raster_mosaics/",bl[j]), format="GTiff",  overwrite=T)
  print(paste("----",bl[j]," saved as GeoTIFF", Sys.time()))
  print("process time")
  print(proc.time() - t1)
  removeTmpFiles(0) #The raster package can store a lot of files. This removes any temp raster files generated   during the loop
}
```

#### Crop raster mosaics {-}

```{r}
ab_bc<-st_read("../Data/Canada/alberta_bc")

# raster mosaic of fixed spatial variables
fixed<-raster::brick("0_data/manual/raster_mosaics/fixed.tif")%>%
  crop(ab_bc)
writeRaster(fixed, filename='0_data/manual/raster_mosaics/fixed_AB_BC.tif', format="GTiff", overwrite=TRUE)


# raster mosaic of time series variables
# summer
ts_summer<-raster::brick("0_data/manual/raster_mosaics/time_series_06.tif")%>%
  crop(ab_bc)
writeRaster(ts_summer, filename="0_data/manual/raster_mosaics/time_series_06_AB_BC.tif", format="GTiff", overwrite=TRUE)

```

#### Combine raster mosaics {-}

```{r eval=FALSE}
ts_summer_AB_BC<-raster::brick("0_data/manual/raster_mosaics/time_series_06_AB_BC.tif")
fixed_AB_BC<-raster::brick("0_data/manual/raster_mosaics/fixed_AB_BC.tif")

gee_all_summer<-brick(fixed_AB_BC, ts_summer_AB_BC)
writeRaster(gee_all_summer, filename="0_data/manual/raster_mosaics/gee_all_summer.tif", format="GTiff", overwrite=TRUE)
```




### Spatial prediction {.unnumbered}

#### Load spatial variable rasters {.unnumbered}

There is no raster data for month and season so we'll create a data
frame with a constant value to plug into the predict function.

```{r eval=FALSE}
Method <- factor('electric', levels = levels(Anguilla_train$Method))
add <- data.frame(Method)
```

#### Create predictive rasters {.unnumbered}

##### Difference between mean temperature {.unnumbered}

```{r eval=FALSE}
p <- predict(Anguilla_grids, angaus.tc5.lr005, const=add,
       n.trees=angaus.tc5.lr005$gbm.call$best.trees, type="response")
p <- mask(p, raster(Anguilla_grids, 1))
plot(p, main='Angaus - BRT prediction')
```

##### Difference between max temperature {.unnumbered}

##### Difference between min temperature {.unnumbered}


