```{r setup, include=FALSE, cache=FALSE}
#Set root directory to R project root
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```
 
```{r}
library(tidyverse)
library(data.table)
```


Connect to Google Drive
```{r}
library(googledrive)


# Define the authentication URL
auth_url <- "https://accounts.google.com/o/oauth2/auth"

# Perform the OAuth 2.0 authentication manually
oauth_token <- oauth2.0_token(
  endpoint = oauth_endpoint(auth_url, "token"),
  app = oauth_app("googledrive", key = "", secret = "", access = "offline"),
  scope = "https://www.googleapis.com/auth/drive",
  use_oob = TRUE
)

# Complete the authentication process
token <- oauth_authorize(oauth_token, auth_url)


```


Access and format raw iButton data

## Link to data from Google Drive

```{r}
# Enter path to microclimate directory
CFS_microclimate<-"~/Library/CloudStorage/GoogleDrive-bgcasey@ualberta.ca/Shared drives/CFS_microclimate/"
```


The script should:
1. scan and read raw csvs
2. combine, clean and format raw csvs
  Get lat long and accuracy from the EpiCollect deployment and retrival form
  should have the following columbs:
   [1] "serial_number" "serial_full"   "mission_id"    "lat"           "long"         
 [6] "accuracy"      "retr_date"     "Date_Time_dpl" "Temperature"   "Date_Time"    
[11] "Month"         "Day"           "Year"    
3. create new folders for metadata and processed files
4. add data from the processed files to other tables defined in the protocols document



### Test on single folder

```{r}

# read individual csvs
file_list <- list.files(path="0_data/test_ibutton_file_structure/Projects/BUMTN2022", full.names = TRUE)

combined_data_1 <- data.frame()
# Loop through each file
for (i in 1:length(file_list)) {
  # Read the data file skipping the first 19 rows
  file_data <- fread(file_list[i],skip = "Date", sep = ",")
  ##extract the first 18 rows
  headers_data <- fread(file_list[i], nrows= 14, sep = ",", header = FALSE, fill = TRUE, blank.lines.skip = TRUE)
  headers_data <- headers_data[,1]
  ##add the file name to combined data
  file_data$serial_full <- substr(headers_data[2], 37,52)
  ##bring in each file name
  file_data$filename <- file_list[i]
  # Append the data to the combined data frame
  combined_data_1 <- bind_rows(combined_data_1, file_data)
}

combined_data_2 <- combined_data_1 %>%
  select(-c(Unit)) %>% 
  mutate(serial_number= str_sub(serial_full, 9, 14)) %>%
  mutate(date_time = dmy_hms(`Date/Time`)) %>% 
  mutate(month=month(date_time))%>%
  mutate(day=day(date_time))%>%
  mutate(year=year(date_time)) %>% 
  rename(temperature= Value)

# Bring in metadata from the epicollect deployment and retrieval table
epc <- read_sheet("https://docs.google.com/spreadsheets/d/17XlD9aDWxbF-hT_lgHHTUPqp7LcqJtmg-D2WjVK31D4/edit#gid=707838738")


# select projects to be processed
projects <- c("BUCL2022", "BUGhost2022", "BUMTN2022")

epc1 <- epc %>% 
  #keep only projects listed in "projects"
  filter(project_id %in% projects) %>%
  # filtered by retrieved ibuttons
  filter(deploy_or_retr=="Retrieved",
         !(serial=="MISSIN")) %>%
  select(c(mission_id, serial,date, lat, long, temp_sens_ht, temp_sens_comments, accuracy)) %>% 
  mutate(retr_date= dmy(date), serial= as.character(serial))







##bring in google sheet to get retrieval dates (Missions update here sheet)
alt_gs <- read_sheet("https://docs.google.com/spreadsheets/d/1k0tpoW2oyqA254Ld69-6nNeHiX_WjwS2vg5TMDDQWVY/edit#gid=266715229")

alt_gs1 <- alt_gs %>% 
  #keep only projects listed in "projects"
  filter(project_id %in% projects)%>%
  filter(retrieved_y_n=="y")



  filter(deploy_or_retr=="Retrieved",
         !(serial=="MISSIN")) %>%



```







### Loop through multiple folders
```{r}
# Set the directory path
directory <- "0_data/test_ibutton_file_structure/Projects"

# Get a list of all project folders in the directory
user_folders <- dir(directory, full.names = TRUE, recursive = FALSE)

# select projects to be processed
user_strings <- c("BUCL2022", "BUGhost2022", "BUMTN2022")

for (folder in user_folders) {
  # Check if the folder name contains any of the user-defined strings
  if (any(sapply(user_strings, grepl, x = folder, ignore.case = TRUE))) {
    # Get a list of files in the current folder
    files <- list.files(folder, full.names = TRUE)
    
    # Print the folder name and corresponding files
    cat("Folder:", folder, "\n")
    cat("Files:", files, "\n\n")
  }
}












# Iterate over each folder
for (folder in folders_all) {
  # Get a list of files in the current folder
  files <- list.files(folder, full.names = TRUE)
  
  # Print the folder name and corresponding files
  cat("Folder:", folder, "\n")
  cat("Files:", files, "\n\n")
  
  ##additional waterton ibuttons
  merge_wtr <- files %>% as.data.frame()
  colnames(merge_wtr)[1] <- "file_name"
  ##get serial numbers from file names
  wtr_ib <- merge_wtr %>% 
    mutate(serial_full= str_sub(file_name, 1, 16),
           serial= str_sub(file_name, 9, 14),
           data_downloaded_y_n= "y") %>% 
    select(-c(file_name))
}
print(head(mk_cleaned))

```


