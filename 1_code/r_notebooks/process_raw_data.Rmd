```{r setup, include=FALSE, cache=FALSE}
#Set root directory to R project root
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```
 
```{r}
library(data.table)
library(tidyverse)
library(googlesheets4)
```

## Process and clean raw iButton data

The script should:
1. scan and read raw csvs
2. combine, clean and format raw csvs
  Get lat long and accuracy from the EpiCollect deployment and retrival form
  should have the following columbs:
   [1] "serial_number" "serial_full"   "mission_id"    "lat"           "long"         
 [6] "accuracy"      "retr_date"     "Date_Time_dpl" "Temperature"   "Date_Time"    
[11] "Month"         "Day"           "Year"    
3. create new folders for metadata and processed files
4. add data from the processed files to other tables defined in the protocols document


```{r}

## ----------------------- Setup -----------------------------
# enter projects to be processed separated by "|"
projects <- "BUCL2022|BUGhost2022|BUMTN2022"

projects <- "BUCL2022"

# Enter path to microclimate directory
CFS_microclimate<-"~/Library/CloudStorage/GoogleDrive-bgcasey@ualberta.ca/Shared drives/CFS_microclimate/"

# projects <- "BUGhost2022"
## -----------------------------------------------------------


## ----------------Bring in project metadata------------------
# Get deployment and project meta data ("Missions update here")
epicollect_dpl_retr <- read_sheet("https://docs.google.com/spreadsheets/d/17XlD9aDWxbF-hT_lgHHTUPqp7LcqJtmg-D2WjVK31D4/edit#gid=707838738")%>%distinct()

# Get retrieval data ("Epicollect deployment and retrieval 2022")
missions_update <- read_sheet("https://docs.google.com/spreadsheets/d/1k0tpoW2oyqA254Ld69-6nNeHiX_WjwS2vg5TMDDQWVY/edit#gid=266715229")
## -----------------------------------------------------------


## ----------------Get a list of directories------------------
# Create a list of folders named raw in directories that match the user specified projects
dirs <- intersect(
        grep("raw",list.dirs(path="0_data/test_ibutton_file_structure/Projects/",recursive=TRUE),value=TRUE),
        grep(projects,list.dirs(path="0_data/test_ibutton_file_structure/Projects/",recursive=TRUE),value=TRUE)
)
## -----------------------------------------------------------

## --------- Process raw csv files in each directory ---------

for (dir in dirs) {

# Get a list of files in the directory lists
file_list <- list.files(dir, pattern='*\\.csv', ignore.case=TRUE, full.names = TRUE, recursive = TRUE)
  
combined_data_1 <- data.frame()
# Loop through each file
for (i in 1:length(file_list)) {
  # Read the data file skipping the first 19 rows
  file_data <- fread(file_list[i],skip = "Date", sep = ",")
  ##extract the first 18 rows
  headers_data <- fread(file_list[i], nrows= 18, sep = ",", header = FALSE, fill = TRUE, blank.lines.skip = TRUE)
  headers_data <- headers_data[,1]
  ##add the file name to combined data
  file_data$serial_full <- substr(headers_data[2], 37,52)
  ##bring in each file name
  file_data$filename <- file_list[i]
  # Append the data to the combined data frame
  combined_data_1 <- bind_rows(combined_data_1, file_data)
}

combined_data_2 <- combined_data_1 %>%
  select(-c(Unit)) %>% 
  mutate(serial_number= str_sub(serial_full, 9, 14)) %>%
  #add project_id field based on the parent directory name
  mutate(project_id=basename(dirname(dir)))%>%
  # add mission id column
  mutate(mission_id=paste(project_id, serial_number, sep="_"))%>%
  mutate(date_time = dmy_hms(`Date/Time`)) %>% 
  select(-c(`Date/Time`)) %>% 
  mutate(month=month(date_time))%>%
  mutate(day=day(date_time))%>%
  mutate(year=year(date_time)) %>% 
  rename(temperature= Value)

combined_data_3 <- combined_data_2 %>%
  left_join(epicollect_dpl_retr, by = join_by(serial_full, project_id, mission_id))%>%
  mutate(serial=as.character(serial))%>%  left_join(missions_update, by = join_by(mission_id, serial_full, serial, project_id))%>%
  rename(c(deployment_date=`deployment_date_(dd/mm/yyyy)`, retrieval_date=`retrieval_date_(dd/mm/yyyy)`))%>%
  dplyr::select(c(project_id, mission_id, serial, lat, long, accuracy, temp_sens_ht, shield_type, deployment_date, retrieval_date, date_time, month, day, year, temperature)) 

# save as a csv within the correct project parent directory
save_dir<-substr(dir, 1, nchar(dir) - 3)
save_dir<- paste0(save_dir, "cleaned/") 

df_name<-paste0(basename(dirname(dir)), "_cleaned")
assign(df_name, combined_data_3)

write_csv(combined_data_3, file=paste0(save_dir, combined_data_3$project_id[1], "_cleaned_", format(Sys.Date(), "%Y%m%d"), ".csv"))
}
```


