```{r setup, include=FALSE, cache=FALSE}
#Set root directory to R project root
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

#setwd(rprojroot::find_rstudio_root_file())
```

```{r eval=FALSE}
library(dplyr)
library(readr)
library(stringr)
```

```{r eval=FALSE}
# load ibutton daily summaries
load("2_pipeline/tmp/ibuttons.rData")
```


### Remove months with incomplete data {.unnumbered}

Removing first month of data if it has only 20 days or less.

```{r eval=FALSE}
ibuttons_1<- ibuttons%>% ungroup()%>%split(f=.$Site_StationKey) %>% lapply(FUN=function(x){
  if (x %>% filter(month(Date)==month(min(Date))& year(Date)==min(year(Date))) %>%
      summarize(max(Day)-min(Day)) %>% c () < 20 ){
    y<-x %>% filter(month(Date)>month(min(Date))| year(Date)> min(year(Date)))    
    
    return(y)
  }else{
    return(x)
  }
}) 
```

Removing last month of data if it has only 20 days or less.

```{r eval=FALSE}
ibuttons_2<-ibuttons_1 %>% lapply(FUN=function(x){
  if (x %>% filter(month(Date)==month(max(Date))& year(Date)==max(year(Date))) %>% 
      summarize(max(Day)-min(Day)) %>% c () < 20 ){
    y<-x %>% filter(month(Date)<month(max(Date))| year(Date)< max(year(Date)))    
    
    #y<-x[!(month(x$Date)==month(min(x$Date) & year(x$Date)==min(year(x$Date)))),]
    return(y)
  }else{
    return(x)
  }
  
}) %>% do.call(rbind,.) #working

```


### Calculate the difference bewteen ERA5 andiButton temps {.unnumbered}

Import ERA 5 daily summaries calculated in google earth engine.

```{r eval=FALSE}
ERA5_d<-read_csv("0_data/manual/gee_tables/ibutton_timeSeries_ERA5_daily.csv")

# convert kelvin to celsius

ERA5_d2<-ERA5_d%>%
  mutate(ERA5_temp_mean= mean_2m_air_temperature-273.15)%>%
  mutate(ERA5_temp_max= maximum_2m_air_temperature-273.15)%>%
  mutate(ERA5_temp_min= minimum_2m_air_temperature-273.15)%>%
  rename(c(Year=year, Month=month, Day=day, Site_StationKey=St_SttK))%>%
  select(Site_StationKey, Year, Month, Day, ERA5_temp_max, ERA5_temp_min, ERA5_temp_mean)

```

```{r eval=FALSE}
#calculate difference between ibuttion and ERA5 temperatures
ibuttons_ERA5<-ibuttons_2%>%
  left_join(ERA5_d2, by = c("Site_StationKey", "Day", "Month", "Year"))%>%
  mutate(Tmax_dif=ERA5_temp_max-Tmax_Day)%>%
  mutate(Tavg_dif=ERA5_temp_mean-Tavg_Day)%>%
  mutate(Tmin_dif=ERA5_temp_min-Tmin_Day)%>%
  filter(is.na(iBt_type)|iBt_type!="BOT")%>%
  # add season columns
  mutate(season_4 = case_when(
      Month %in%  9:11 ~ "Fall",
      Month %in%  c(12, 1, 2)  ~ "Winter",
      Month %in%  3:5  ~ "Spring",
      TRUE ~ "Summer"))%>%
  mutate( season_2 = case_when(
      Month %in%  c(10:12, 1, 2,3) ~ "Winter",
      TRUE ~ "Summer"))
# %>%
#   drop_na(ERA5_temp_max)

```


### Remove outliers {.unnumbered}

```{r eval=FALSE}

# remove outliers based on interquartile range

d<-ibuttons_ERA5%>%
  filter(Tmax_Day< 50)


d1<-d %>%
    group_by(Site_StationKey, season_2) %>%
    filter(between(Tmax_Day, quantile(Tmax_Day, .25, )-(3*IQR(Tmax_Day)), quantile(Tmax_Day, .75, )+(3*IQR(Tmax_Day))))%>%
    filter(between(Tmin_Day, quantile(Tmin_Day, .25, )-(3*IQR(Tmin_Day)), quantile(Tmin_Day, .75, )+(3*IQR(Tmin_Day))))%>%
    filter(between(Tavg_Day, quantile(Tavg_Day, .25, )-(3*IQR(Tavg_Day)), quantile(Tavg_Day, .75, )+(3*IQR(Tavg_Day))))%>%
    ungroup()%>%
    filter(is.na(Tmax_dif)|between(Tmax_dif, quantile(Tmax_dif, .25, na.rm=TRUE)-(3*IQR(Tmax_dif, na.rm=TRUE)), quantile(Tmax_dif, .75, na.rm=TRUE)+(3*IQR(Tmax_dif, na.rm=TRUE))))%>%
filter(is.na(Tmin_dif)|between(Tmin_dif, quantile(Tmin_dif, .25, na.rm=TRUE)-(3*IQR(Tmin_dif, na.rm=TRUE)), quantile(Tmin_dif, .75, na.rm=TRUE)+(3*IQR(Tmin_dif, na.rm=TRUE))))%>%
filter(is.na(Tavg_dif)|between(Tavg_dif, quantile(Tavg_dif, .25, na.rm=TRUE)-(3*IQR(Tavg_dif, na.rm=TRUE)), quantile(Tavg_dif, .75, na.rm=TRUE)+(3*IQR(Tavg_dif, na.rm=TRUE))))

  

#via sd
t<-d %>%
  filter(between(Tmax_Day, mean(Tmax_Day, na.rm=TRUE) - (3 * sd(Tmax_Day, na.rm=TRUE)), 
                     mean(Tmax_Day, na.rm=TRUE) + (3 * sd(Tmax_Day, na.rm=TRUE))))

d2<-d %>%
    group_by(Site_StationKey, season_2) %>%
    filter(between(Tmax_Day, mean(Tmax_Day)-(3*sd(Tmax_Day)), mean(Tmax_Day)+(3*sd(Tmax_Day))))%>%
    filter(between(Tmin_Day, mean(Tmin_Day)-(3*sd(Tmin_Day)), mean(Tmin_Day)+(3*sd(Tmin_Day))))%>%
    filter(between(Tavg_Day, mean(Tavg_Day)-(3*sd(Tavg_Day)), mean(Tavg_Day)+(3*sd(Tavg_Day))))%>%
    ungroup()%>%
    filter(is.na(Tmax_dif)|between(Tmax_dif, mean(Tmax_dif,  na.rm=TRUE)-(3*sd(Tmax_dif, na.rm=TRUE)), mean(Tmax_dif,  na.rm=TRUE)+(3*sd(Tmax_dif, na.rm=TRUE))))%>%
filter(is.na(Tmin_dif)|between(Tmin_dif, mean(Tmin_dif,  na.rm=TRUE)-(3*sd(Tmin_dif, na.rm=TRUE)), mean(Tmin_dif,  na.rm=TRUE)+(3*sd(Tmin_dif, na.rm=TRUE))))%>%
filter(is.na(Tavg_dif)|between(Tavg_dif, mean(Tavg_dif,  na.rm=TRUE)-(3*sd(Tavg_dif, na.rm=TRUE)), mean(Tavg_dif,  na.rm=TRUE)+(3*sd(Tavg_dif, na.rm=TRUE))))

```


### Impute missing data {.unnumbered}

#### Create a dummy iButton data frame

The data frame will have rows for every day during the time period the iButtons were deployed. Daily temperature columns will be filled with NA values.

Create a calendar for the time iButtons were deployed.

```{r eval=FALSE}
ibuttons<-d2%>%
  mutate(project_year=str_c(Project, "_", Year))%>%
  select("Project","Site_StationKey", "Day", "Month","Year", "project_year", "Date", "iBt_type",  "Tmax_Day","Tmin_Day",  "Tavg_Day")
        
months <- 1:12

# create a data frame with the number of days per month
days <- days_in_month(months) %>% as.data.frame() %>% `colnames<-`("Days") %>%
  mutate(Month=row.names(.))


# create a list of months 
calendar<-apply(days,MARGIN = 1,FUN=function(x){
 seq(1:x)
  } 
 ) %>%
  lapply(.,FUN = unlist)


#create a calendar data frame with all of the days of the year for all stations. The dataframe will have columns for day, month,  and year and spans the time of the ibuttons
calendar_step1<-calendar %>% `names<-`(days$Month) %>% unlist() %>% as.data.frame() %>%
  `colnames<-`("Day") %>% mutate(Month_name=substr(rownames(.),1,3)) %>%
  left_join(data.frame(Month_name=month.abb,Month=months)) %>%
  expand_grid(.,Year=c(min(ibuttons$Year):max(ibuttons$Year)))
```

Create the dummy data frame that includes all of the days/year of the above calendar data frame with NA instead of temperature values.

```{r eval=FALSE}

ibuttons<-ibuttons%>%
  mutate(project_year=str_c(Project, "_", Year))


calendar_final<-ibuttons%>%
  ungroup%>%
  select(Site_StationKey, Project)%>%
  unique() %>%
 `colnames<-` (c("Site_StationKey","Project")) %>%
  expand_grid(.,calendar_step1)%>% mutate(iBt_type=NA,Tmax_Day=NA,Tmin_Day=NA,Tavg_Day=NA)%>%
  mutate(project_year=str_c(Project, "_", Year))%>%
  # group_by(project)%>%
  filter(project_year %in% unique(ibuttons$project_year))%>%
  select(-c(iBt_type,Project, Month_name, project_year))

```

#### Remove months with too many missing days {.unnumbered}

We need to trim down the missing days for months in which up to 10 days of data are missing.

```{r eval=FALSE}

# create a data frame of days with missing data
missing_days<-anti_join(calendar_final %>% ungroup,
          ibuttons %>% ungroup() %>% select(!c(iBt_type,Project)),
          by=c("Site_StationKey","Day","Month","Year"))



# count the number of missing days and remove iButton months that are missing over 10 days of data
missing_of_importance<-missing_days %>% group_by(Site_StationKey,Month,Year) %>%
  summarize(count=n()) %>% filter(count<11) %>% mutate(keep="TRUE")

missing_days_final<-left_join(missing_days,missing_of_importance,by=c("Site_StationKey","Month","Year")) %>%
  filter(keep=="TRUE") %>% select(-c(count,keep))

#### Final iButton data frame with missing days {-}

complete_data_w_missing<-ibuttons %>% ungroup() %>% select(!c(iBt_type,Project)) %>%
  bind_rows(missing_days_final)

# create a column with the season
complete_data_w_missing_summer<- complete_data_w_missing %>% filter(Month %in% c(6,7,8))
complete_data_w_missing_winter<- complete_data_w_missing %>% filter(Month %in% c(12,1,2))
complete_data_w_missing_fall<- complete_data_w_missing %>% filter(Month %in% c(9,10,11))
complete_data_w_missing_spring<- complete_data_w_missing %>% filter(Month %in% c(3,4,5))

ib_cal<-bind_rows("Summer"=complete_data_w_missing_summer,
          "Winter"=complete_data_w_missing_winter,"Fall"=complete_data_w_missing_fall,"Spring"=complete_data_w_missing_spring, .id="Season")
```


#### Impute missing values {.unnumbered}

Impute NA values using a spline function based on time series imputation. The imputation is based on month per year per iButton site.

```{r eval=FALSE}

inputted_summer<-ddply(complete_data_w_missing_summer,.(Site_StationKey,Month,Year),.fun = 
        function(x){
          na_interpolation(x,option="spline")
        })


inputted_winter<-ddply(complete_data_w_missing_winter,.(Site_StationKey,Month,Year),.fun = 
                         function(x){
                           na_interpolation(x,option="spline")
                         })
inputted_fall<-ddply(complete_data_w_missing_fall,.(Site_StationKey,Month,Year),.fun = 
                         function(x){
                           na_interpolation(x,option="spline")
                         })


inputted_spring<-ddply(complete_data_w_missing_spring,.(Site_StationKey,Month,Year),.fun = 
                         function(x){
                           na_interpolation(x,option="spline")
                         })


complete_data<-bind_rows(inputted_summer,inputted_winter,inputted_fall,inputted_spring)

#save
ibuttons_complete_daily<-complete_data
save(ibuttons_complete_daily, file="0_data/manual/iButton_data/ibuttons_complete_daily.rData")

write.csv(ibuttons_complete_daily, file="0_data/manual/iButton_data/ibuttons_complete_daily.csv")

```


### Calculate Temp dif and diurnal range for the newly imputed values {-}

```{r eval=False}

ibuttons_ERA5_2<-ibuttons_complete_daily%>%
  left_join(ERA5_d2, by = c("Site_StationKey", "Day", "Month", "Year"))%>%
  mutate(Tmax_dif=ERA5_temp_max-Tmax_Day)%>%
  mutate(Tavg_dif=ERA5_temp_mean-Tavg_Day)%>%
  mutate(Tmin_dif=ERA5_temp_min-Tmin_Day)%>%
  mutate(T_diurnal=Tmax_Day-Tmin_Day)%>%
  mutate(Date = make_date(Year, Month, Day))%>%
  mutate(season_4 = case_when(
      Month %in%  9:11 ~ "Fall",
      Month %in%  c(12, 1, 2)  ~ "Winter",
      Month %in%  3:5  ~ "Spring",
      TRUE ~ "Summer"))%>%
  mutate( season_2 = case_when(
      Month %in%  c(10:12, 1, 2,3) ~ "Winter",
      TRUE ~ "Summer"))

```
 
#### Snow burial {-}

We defined snow burial as ibuttons with a diural range of <3 degrees for 25 consequetive days or more. [@wood2017dtdf]

```{r eval=FALSE}
#define how may consecutive days are needed to define as snow
snow_thresh<-25

d<-ibuttons_ERA5_2%>%
  filter(T_diurnal<3)%>% #filter to diurnal range <3
  # mutate(lag_date=Date - days(1))%>%
  group_by(Site_StationKey)%>%
  arrange(Site_StationKey, Date)%>%
  # mutate(consecutive_day_flag = if_else(Date == (Date - days(1), 1, 0))%>%
  mutate(lag_date=lag(Date))%>%
  mutate(consecutive_day_flag = if_else(Date == (lag(Date) + days(1)), 1, 0))%>% # flag consecutive days
  mutate(consecutive_day_flag =replace_na(consecutive_day_flag, 0))%>%# flag consecutive days
  mutate(snow_burial=rep(rle(consecutive_day_flag)$length>=snow_thresh,rle(consecutive_day_flag)$length))%>% #flag dates that are a part of  sequence
  # filter(snow_burial==TRUE)%>%
  right_join(ibuttons_ERA5_2)%>% # join back with the original data frame
  mutate(snow_burial=replace_na(snow_burial, "FALSE"))%>%
  select(-c(consecutive_day_flag, lag_date))%>%
  # arrange(Site_StationKey, Date)%>%
  # filter(snow_burial==FALSE)%>%
  # select(c(Site_StationKey, Date, T_diurnal, lag_date, consecutive_day_flag))%>%
  arrange(Site_StationKey, Date)%>%
  filter(snow_burial=="FALSE")

# remove difference outliers
d1<-d %>%
filter(is.na(Tmax_dif)|between(Tmax_dif, quantile(Tmax_dif, .25, na.rm=TRUE)-(3*IQR(Tmax_dif, na.rm=TRUE)), quantile(Tmax_dif, .75, na.rm=TRUE)+(3*IQR(Tmax_dif, na.rm=TRUE))))%>%
filter(is.na(Tmin_dif)|between(Tmin_dif, quantile(Tmin_dif, .25, na.rm=TRUE)-(3*IQR(Tmin_dif, na.rm=TRUE)), quantile(Tmin_dif, .75, na.rm=TRUE)+(3*IQR(Tmin_dif, na.rm=TRUE))))%>%
filter(is.na(Tavg_dif)|between(Tavg_dif, quantile(Tavg_dif, .25, na.rm=TRUE)-(3*IQR(Tavg_dif, na.rm=TRUE)), quantile(Tavg_dif, .75, na.rm=TRUE)+(3*IQR(Tavg_dif, na.rm=TRUE))))

ibuttons_complete_daily_noSnow<-d1

save(ibuttons_complete_daily_noSnow, file="0_data/manual/iButton_data/ibuttons_complete_daily_noSnow.rData")

write.csv(ibuttons_complete_daily_noSnow, file="0_data/manual/iButton_data/ibuttons_complete_daily_noSnow,.csv")

```


### Monthly summaries {.unnumbered}

```{r eval=FALSE}
load("0_data/manual/iButton_data/ibuttons_complete_daily_noSnow.rData")
ibuttons_complete_monthly<-ibuttons_complete_daily_noSnow %>%
        group_by(Site_StationKey,Month,Year)%>%
        select(-c(Day, Date, project_year, ERA5_temp_max,ERA5_temp_min,ERA5_temp_mean, Tmax_dif, Tavg_dif, Tmin_dif, T_diurnal,lag_date, snow_burial))%>%
        summarise_all(list(mean))%>%
        mutate(Project=gsub("\\-*","", Site_StationKey))%>% # add back in a project column
        mutate(Project=gsub('[[:digit:]]+', '', Project))%>%   
        arrange(Site_StationKey, Year, Month)%>%
        rename(c(Tmax_Month=Tmax_Day, Tmin_Month=Tmin_Day, Tavg_Month=Tavg_Day))
  
save(ibuttons_complete_monthly, file="0_data/manual/iButton_data/ibuttons_complete_monthly.rData")

write.csv(ibuttons_complete_monthly, file="0_data/manual/iButton_data/ibuttons_complete_monthly.csv")
```

```{r echo=FALSE, message = FALSE, results="asis"}
load("0_data/manual/iButton_data/ibuttons_complete_monthly.rData")

knitr::kable(head(ibuttons_complete_monthly), "pipe") 
```

